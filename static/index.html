<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>News Automation ‚Äî Painel</title>
<style>
  :root{--bg:#0b0d10;--card:#12151a;--muted:#9aa4b2;--text:#e6ebf2;--acc:#4da3ff;--acc2:#22c55e;--border:#1f2630}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,Ubuntu;background:#0d1117;color:var(--text)}
  .wrap{max-width:1040px;margin:24px auto;padding:0 16px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:12px 0 20px}
  .muted{color:var(--muted)} .brand{font-weight:700}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}@media(min-width:880px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input,button,select{border:1px solid var(--border);background:#0f1318;color:var(--text);border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
  button{cursor:pointer;border:0;background:var(--acc);color:#07131f;font-weight:700}
  button.secondary{background:#1f2937;color:#e5eef9;border:1px solid var(--border)}
  .results{margin-top:10px;display:grid;grid-template-columns:1fr;gap:14px}@media(min-width:720px){.results{grid-template-columns:1fr 1fr}}
  .news{background:#0f1318;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .img-wrap{height:170px;background:#0b0e12;display:flex;align-items:center;justify-content:center}
  .news img{width:100%;height:100%;object-fit:cover}.cnt{padding:12px 12px 14px}
  .title{font-weight:700;line-height:1.2;margin:0 0 8px}
  .badge{display:inline-block;font-size:12px;color:#c8d3e1;background:#122233;border:1px solid #1b3049;padding:2px 8px;border-radius:999px}
  .status{font-size:14px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div><div class="brand">üóûÔ∏è News Automation</div><div class="muted">Coletor por palavra-chave ou link. Exporte em RSS/JSON.</div></div>
    <a class="badge" href="/healthz" target="_blank">/healthz</a>
  </header>

  <div class="grid">
    <div class="card">
      <h3>Buscar por palavras-chave</h3>
      <div class="row">
        <input id="kw" placeholder="Ex.: brasil, economia, turismo" style="flex:1" />
        <select id="hours">
          <option value="12">√öltimas 12h</option>
          <option value="8">√öltimas 8h</option>
          <option value="6">√öltimas 6h</option>
          <option value="24">√öltimas 24h</option>
        </select>
        <button id="btnCrawl">Coletar agora</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input type="checkbox" id="reqH1" checked> Exigir H1/t√≠tulo</label>
        <label><input type="checkbox" id="reqImg"> Exigir imagem</label>
        <span style="flex:1"></span>
        <input id="kwLive" placeholder="Listar: slug/palavra" style="flex:1;max-width:380px" />
        <button class="secondary" id="btnList">Listar</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="muted">Links do slug:</span>
        <a class="badge" id="lnkRss" target="_blank">RSS</a>
        <a class="badge" id="lnkJson" target="_blank">JSON</a>
      </div>
      <div class="status" id="status"></div>
    </div>

    <div class="card">
      <h3>Adicionar link espec√≠fico</h3>
      <div class="row"><input id="linkUrl" placeholder="https://site.com/noticia (ou l.facebook.com/l.php?u=...)" style="flex:1" /></div>
      <div class="row" style="margin-top:8px">
        <input id="linkKw" placeholder="Palavra-chave (ex.: meu-topico)" />
        <button class="secondary" id="btnAdd">Adicionar</button>
      </div>
      <div class="status" id="statusAdd"></div>
    </div>
  </div>

  <div style="margin:18px 0 8px" class="muted">Resultados</div>
  <div class="results" id="results"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const fmtDate = iso => iso ? new Date(iso).toLocaleString("pt-BR",{dateStyle:"short",timeStyle:"short"}) : "";
const slugify = s => s.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");

function card(it){
  const hrefItem = `/item/${it.id}`;
  const src = it.image || "";
  const srcName = it.source_name || "";
  const title = it.title || "(sem t√≠tulo)";
  const pub = fmtDate(it.published_at);
  const created = fmtDate(it.created_at);
  return `<div class="news">
    <div class="img-wrap">${src?`<img src="${src}" alt="">`:`<div class="muted">sem imagem</div>`}</div>
    <div class="cnt">
      <div class="title"><a href="${hrefItem}" target="_blank" rel="noopener">${title}</a></div>
      <div class="muted" style="font-size:13px">${srcName}${pub?" ‚Ä¢ "+pub:""}</div>
      <div style="margin-top:6px"><a class="badge" href="${hrefItem}" target="_blank">Ver Limpinho</a> <a class="badge" href="${it.url}" target="_blank">Mat√©ria Original</a></div>
      <div class="muted" style="font-size:12px;margin-top:6px">coletado: ${created||"-"}</div>
    </div>
  </div>`;
}

async function apiList(keyword, hours){
  const r = await fetch(`/api/list?keyword=${encodeURIComponent(keyword)}&hours=${hours}`);
  if(!r.ok) throw new Error("Erro ao listar"); const d = await r.json(); return d.items||[];
}
async function crawl(keywords, hours, require_h1, require_image){
  const r = await fetch("/crawl", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ keywords, hours_max: hours, require_h1, require_image })
  });
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
async function addLink(url, keyword, require_h1, require_image){
  const r = await fetch("/add", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ url, keyword, require_h1, require_image })
  });
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
function render(items){ $("#results").innerHTML = (items&&items.length)? items.map(card).join("") : `<div class="muted">Sem resultados para exibir.</div>`; }
function updateExportLinks(slug){ $("#lnkRss").href=`/rss/${slug}`; $("#lnkJson").href=`/api/json/${slug}`; }

$("#btnCrawl").onclick = async () => {
  const raw = $("#kw").value.trim(); if(!raw) return alert("Digite palavras-chave (separe por v√≠rgula)");
  const hours = Number($("#hours").value||12); const reqH1=$("#reqH1").checked; const reqImg=$("#reqImg").checked;
  const kws = raw.split(",").map(s=>s.trim()).filter(Boolean);
  const firstSlug = slugify(kws[0]); $("#kwLive").value = firstSlug; updateExportLinks(firstSlug);
  $("#status").textContent = "Coletando‚Ä¶";
  try{
    const data = await crawl(kws, hours, reqH1, reqImg);
    const stats = data.stats[firstSlug] || {};
    const items = await apiList(firstSlug, hours);
    render(items);
    $("#status").innerHTML = `OK. Mostrando: <b>${firstSlug}</b> (janela ${hours}h). `+
      `Passaram: <b>${stats.ok||0}</b> ‚Ä¢ Descartes ‚Äî H1: <b>${stats.no_h1||0}</b>, Img: <b>${stats.no_image||0}</b>, P: <b>${stats.no_paragraphs||0}</b>, Fetch: <b>${stats.fetch_fail||0}</b>`;
  }catch(e){ $("#status").textContent = "Erro: "+e.message; }
};

$("#btnList").onclick = async () => {
  const kw = $("#kwLive").value.trim(); if(!kw) return alert("Informe o slug para listar");
  const hours = Number($("#hours").value||12);
  try{ const items = await apiList(kw, hours); render(items); updateExportLinks(kw); $("#status").innerHTML = `Listando: <b>${kw}</b> (√∫ltimas ${hours}h)`; }
  catch(e){ $("#status").textContent = "Erro: "+e.message; }
};

$("#btnAdd").onclick = async () => {
  const url = $("#linkUrl").value.trim(); if(!url) return alert("Cole o link");
  const kw = ($("#linkKw").value.trim()) || "geral";
  const reqH1=$("#reqH1").checked; const reqImg=$("#reqImg").checked;
  $("#statusAdd").textContent = "Adicionando‚Ä¶";
  try{
    await addLink(url, kw, reqH1, reqImg);
    const slug = slugify(kw); const hours = Number($("#hours").value||12);
    const items = await apiList(slug, hours);
    render(items); $("#kwLive").value = slug; updateExportLinks(slug);
    $("#statusAdd").textContent = "Link adicionado.";
  }catch(e){ $("#statusAdd").textContent = "Erro: "+e.message; }
};
</script>
</body>
</html>
